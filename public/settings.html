<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostazioni - 56k Knowledge Hub</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/settings.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">56k</div>
        <div class="loading-text">Caricamento impostazioni...</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Main Container -->
    <div class="settings-container" id="settingsContainer" role="application">
        <!-- Header -->
    <div class="settings-header" role="banner">
            <div class="header-content">
                <div class="header-left">
                    <button class="back-button btn-outline" onclick="goBack()">
                        <span>‚Üê</span> Torna all'app
                    </button>
                    <h1>Impostazioni</h1>
                </div>
                <div class="header-right">
                    <span class="user-info" id="userInfo"></span>
                    <span class="theme-toggle" id="themeToggleWrapper">
                        <button type="button" id="themeToggleBtn" aria-pressed="false" aria-label="Attiva dark mode">üåô Dark</button>
                    </span>
                    <button id="tab-admin-settings" class="settings-tab-btn" style="display:none;margin-left:12px" aria-controls="admin-settings-section">Admin</button>
                </div>
            </div>
        </div>

        <!-- Settings Content -->
    <div class="settings-content" role="main">
            <!-- API Configuration Section -->
            <div class="settings-section">
                <h2>üîë Configurazione API</h2>
                <p class="section-description">
                    Gestisci le chiavi API per i servizi integrati. Le chiavi esistenti sono nascoste per sicurezza.
                </p>

                <!-- Claude API -->
                <div class="config-card">
                    <div class="config-header">
                        <h3>Claude AI</h3>
                        <span class="status-badge" id="claudeStatus">Non configurato</span>
                    </div>
                    <div class="config-body">
                        <div class="form-group">
                            <label for="claudeApiKey">API Key</label>
                            <div class="input-with-button">
                                <input 
                                    type="password" 
                                    id="claudeApiKey" 
                                    class="form-input" 
                                    placeholder="sk-ant-api03-..."
                                    autocomplete="off"
                                >
                                <button class="test-button btn-outline" onclick="testConnection('claude')">Test</button>
                            </div>
                            <small class="help-text">
                                Ottieni la tua API key da <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Google OAuth -->
                <div class="config-card">
                    <div class="config-header">
                        <h3>Google OAuth</h3>
                        <span class="status-badge" id="googleStatus">Non configurato</span>
                    </div>
                    <div class="config-body">
                        <div class="form-group">
                            <label for="googleClientId">Client ID</label>
                            <input 
                                type="text" 
                                id="googleClientId" 
                                class="form-input" 
                                placeholder="xxxxx.apps.googleusercontent.com"
                                autocomplete="off"
                            >
                        </div>
                        <div class="form-group">
                            <label for="googleClientSecret">Client Secret</label>
                            <div class="input-with-button">
                                <input 
                                    type="password" 
                                    id="googleClientSecret" 
                                    class="form-input" 
                                    placeholder="GOCSPX-..."
                                    autocomplete="off"
                                >
                                <button class="test-button btn-outline" onclick="testConnection('google')">Test</button>
                            </div>
                            <small class="help-text">
                                Configura OAuth in <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- ClickUp OAuth -->
                <div class="config-card">
                    <div class="config-header">
                        <h3>ClickUp OAuth</h3>
                        <span class="status-badge warning" id="clickupStatus">Opzionale</span>
                    </div>
                    <div class="config-body">
                        <div class="form-group">
                            <label for="clickupClientId">Client ID</label>
                            <input 
                                type="text" 
                                id="clickupClientId" 
                                class="form-input" 
                                placeholder="Client ID ClickUp"
                                autocomplete="off"
                            >
                        </div>
                        <div class="form-group">
                            <label for="clickupClientSecret">Client Secret</label>
                            <div class="input-with-button">
                                <input 
                                    type="password" 
                                    id="clickupClientSecret" 
                                    class="form-input" 
                                    placeholder="Client Secret ClickUp"
                                    autocomplete="off"
                                >
                                <button class="test-button btn-outline" onclick="testConnection('clickup')">Test</button>
                            </div>
                            <small class="help-text">
                                Crea un'app in <a href="https://app.clickup.com" target="_blank">ClickUp Settings</a>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="action-buttons">
                    <button class="btn-gradient" onclick="saveConfiguration()">üíæ Salva Configurazione</button>
                </div>
            </div>

            <!-- User Preferences Section -->
            <div class="settings-section">
                <h2>‚öôÔ∏è Preferenze Utente</h2>
                <p class="section-description">
                    Personalizza la tua esperienza con l'applicazione.
                </p>

                <div class="config-card">
                    <div class="config-body">
                        <div class="form-group">
                            <label for="defaultModel">Modello Claude predefinito</label>
                            <select id="defaultModel" class="form-input">
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="allowedDomain">Dominio email consentito</label>
                            <input 
                                type="text" 
                                id="allowedDomain" 
                                class="form-input" 
                                placeholder="56k.agency"
                                value="56k.agency"
                            >
                            <small class="help-text">
                                Solo gli utenti con email @dominio potranno accedere
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Save Preferences Button -->
                <div class="action-buttons">
                    <button class="btn-outline" onclick="savePreferences()">üíæ Salva Preferenze</button>
                </div>
            </div>

            <!-- System Info Section -->
            <div class="settings-section">
                <h2>üìä Informazioni Sistema</h2>
                <div class="config-card">
                    <div class="config-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Versione:</span>
                                <span class="info-value">1.0.0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Database:</span>
                                <span class="info-value" id="dbStatus">SQLite</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Server:</span>
                                <span class="info-value" id="serverStatus">Node.js</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Ultimo backup:</span>
                                <span class="info-value" id="lastBackup">Mai</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Settings Section (visible only to admins) -->
            <section id="admin-settings-section" class="settings-section" style="display:none;margin-top:18px" aria-hidden="true">
                <h2>üîß Impostazioni Admin</h2>
                <p class="section-description">Impostazioni non sensibili e comportamentali dell'applicazione. Visibile solo agli amministratori.</p>

                <div class="config-card">
                    <div class="config-body">
                        <form id="admin-settings-form">
                            <div class="form-group">
                                <label for="frontend_url">Frontend URL</label>
                                <input id="frontend_url" name="FRONTEND_URL" type="url" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="drive_max_bytes">Drive max bytes</label>
                                <input id="drive_max_bytes" name="DRIVE_MAX_BYTES" type="number" min="1024" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="drive_cache_ttl">Drive cache TTL (sec)</label>
                                <input id="drive_cache_ttl" name="DRIVE_CACHE_TTL" type="number" min="60" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="clickup_cache_ttl">ClickUp cache TTL (sec)</label>
                                <input id="clickup_cache_ttl" name="CLICKUP_CACHE_TTL" type="number" min="60" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="max_drive_files">Max Drive files to fetch</label>
                                <input id="max_drive_files" name="MAX_DRIVE_FILES_TO_FETCH" type="number" min="1" max="20" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="max_clickup_tasks_enrich">Max ClickUp tasks to enrich</label>
                                <input id="max_clickup_tasks_enrich" name="MAX_CLICKUP_TASKS_ENRICH" type="number" min="1" max="20" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="drive_export_max_chars">Drive export max chars</label>
                                <input id="drive_export_max_chars" name="DRIVE_EXPORT_MAX_CHARS" type="number" min="1000" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="enable_pdf_parse">Enable PDF parse</label>
                                <select id="enable_pdf_parse" name="ENABLE_PDF_PARSE" class="form-input">
                                    <option value="true">True</option>
                                    <option value="false">False</option>
                                </select>
                            </div>

                            <div class="form-group actions">
                                <button type="button" id="admin-settings-restore" class="btn-outline">Ripristina default</button>
                                <button type="submit" id="admin-settings-save" class="btn-gradient">Salva</button>
                            </div>

                            <div id="admin-settings-msg" role="status" aria-live="polite" class="muted" style="margin-top:8px"></div>
                        </form>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Footer -->
    <footer class="app-footer" id="appFooter">
        <span>¬© 2025 56k Knowledge Hub</span>
        <span id="footerStatus" class="badge badge-info" style="display:none">Dark Mode</span>
    </footer>

    <script src="js/settings.js"></script>
    <script>
    (function(){
        const btn = document.getElementById('themeToggleBtn');
        if(!btn) return;
        const root = document.documentElement;
        const STORAGE_KEY = 'app-theme';
        // Init
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved === 'dark') {
            root.setAttribute('data-theme','dark');
            btn.setAttribute('aria-pressed','true');
            btn.textContent = '‚òÄÔ∏è Light';
        }
        btn.addEventListener('click', () => {
            const isDark = root.getAttribute('data-theme') === 'dark';
            if(isDark) {
                root.removeAttribute('data-theme');
                localStorage.setItem(STORAGE_KEY,'light');
                btn.setAttribute('aria-pressed','false');
                btn.textContent = 'üåô Dark';
            } else {
                root.setAttribute('data-theme','dark');
                localStorage.setItem(STORAGE_KEY,'dark');
                btn.setAttribute('aria-pressed','true');
                btn.textContent = '‚òÄÔ∏è Light';
            }
        });
    })();
    </script>
</body>
</html>
